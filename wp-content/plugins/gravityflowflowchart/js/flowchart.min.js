!function(a,b){b(document).ready(function(){function c(){b("#flowchart-spinner").show()}function d(){b("#flowchart-spinner").hide()}function e(a,c){r.scale(a,c),b("#zoom-level").text(Math.round(100*p)+"%")}function f(){p-=.1,e(p,p)}function g(){p+=.1,e(p,p)}function h(){function a(){b.get(ajaxurl+"?action=gravityflowflowchart_get_step_data&_wpnonce="+j.vars.nonce+"&id="+m,function(a){i=JSON.parse(a),f()})}function f(){var a=[];o.resetCells(a);var b=new joint.shapes.basic.Rect({position:{x:100,y:50},size:{width:200,height:50},attrs:{rect:{fill:"green",rx:15,ry:30},text:{text:"start",fill:"white"}},ports:{groups:{out:{position:{name:"bottom",args:{}}}}}}),c={id:"start",group:"out",args:{},label:{position:{name:"bottom",args:{}}},attrs:{circle:{fill:"white"}},markup:'<circle r="5" stroke="#000000" fill="white"/>'};b.addPort(c),a.push(b);var d,f,j,k,l,m,q,r,s,t,u,v,w=[],x=[];for(f=0,j=i.length;f<j;f++){for(k=i[f],x[k.id]=k,l=joint.util.breakText(k.name,{width:180}),"string"==typeof k.icon?(t=null,u={"xlink:href":k.icon,"ref-x":10,"ref-y":75,ref:"rect",width:16,height:16}):(k.icon.text=String.fromCharCode(parseInt(k.icon.text,16)),t={text:k.icon.text,fill:k.icon.color,"font-size":16,"ref-x":10,"ref-y":75,ref:"rect",width:16,height:16,"font-family":"FontAwesome"},u={"xlink:href":null,"ref-x":10,"ref-y":75,ref:"rect",width:16,height:16}),v=k.scheduled?{text:"ï€—",fill:"gray","font-size":16,"ref-x":180,"ref-y":10,ref:"rect",width:16,height:16,"font-family":"FontAwesome"}:null,m=new joint.shapes.basic.Generic({markup:'<g class="rotatable"><g class="scalable"><rect/></g><a><text class="step-schedule-icon"/><text class="step-name"/><image class="step-image-icon"/><text class="step-text-icon"/><text class="step-type"/></a></g>',position:{x:100,y:50+50*f},size:{width:200,height:100},attrs:{rect:{fill:"white",stroke:"black",width:200,height:100,rx:10,ry:10},".step-schedule-icon":v,".step-name":{text:l,fill:"gray","font-size":12,"ref-x":.5,"ref-y":20,ref:"rect","x-alignment":"middle","font-family":"sans-serif"},".step-image-icon":u,".step-text-icon":t,".step-type":{text:k.label,fill:"gray","font-size":12,"ref-x":20,"ref-y":2,ref:"image","font-family":"sans-serif"},a:{xlinkHref:k.settings_url,cursor:"pointer"}},ports:{groups:{in:{position:{name:"top",args:{}},markup:'<circle r="5" stroke="#000000" fill="white"/>'},out:{position:{name:"bottom",args:{}}}}}}),d={id:"in",group:"in",args:{},label:{position:{name:"top",args:{}}},markup:'<circle r="5" stroke="#000000" fill="white"/>'},m.addPort(d),r=0;r<k.targets.length;r++){switch(C=k.targets[r].status){case"approved":q="green";break;case"rejected":q="red";break;case"reverted":q="blue";break;case"expired":q="purple";break;case"skipped":q="silver";break;default:q="white"}s={id:k.targets[r].status,group:"out",args:{},label:{position:{name:"bottom",args:{}}},attrs:{circle:{fill:q}},markup:'<circle r="5" stroke="#000000" fill="'+q+'"/>'},m.addPort(s)}a.push(m),w["id"+k.id]=m}var y=new joint.shapes.basic.Rect({position:{x:100,y:50+50*f},size:{width:200,height:50},attrs:{rect:{fill:"red",rx:15,ry:30},text:{text:"complete",fill:"white"}}});a.push(y);var z,A,B,C,D,E,F,G,H;for(f=0;f<j;f++)for(k=i[f],m=w["id"+i[f].id],0==f&&(z=n({id:b.id,port:"start"},{id:m.id,port:"in"}),a.push(z)),A=0;A<k.targets.length;A++){switch(B=k.targets[A].step_id,C=k.targets[A].status,C=k.targets[A].status){case"approved":D="green";break;case"rejected":D="red";break;case"reverted":D="blue";break;case"expired":D="purple";break;case"skipped":D="silver";break;default:D="gray"}E=k.targets[A].status,"complete"==E&&(E=""),F="skipped"==C,"complete"==B?(z=n({id:m.id,port:C},{id:y.id},E,D,F),a.push(z)):(G=w["id"+B],H=n({id:m.id,port:C},{id:G.id,port:"in"},E,D,F),a.push(H))}e(p,p),o.addCells(a),g(),h()}function g(){joint.layout.DirectedGraph.layout(o,{nodeSep:75,edgeSep:50,rankSep:70,marginX:50,marginY:50,rankDir:"TD",ranker:"longest-path"}),o.resetCells(o.getCells())}function h(){r.fitToContent("100%",null,100)}function n(a,b,c,d,e,f,g){f||(f="bottom"),g||(g="top");var h={source:a,target:b,router:{name:"manhattan",args:{startDirections:[f],endDirections:[g],maximumLoops:1e3,maxAllowedDirectionChange:9999,perpendicular:!0,excludeEnds:!1,step:10}},connector:{name:"rounded"},attrs:{".connection":{stroke:"#CCCCCC","stroke-width":2},".marker-target":{fill:"#333333",d:"M 10 0 L 0 5 L 10 10 z"},".marker-arrowheads":{display:"none"},".link-tools":{display:"none"}}};return e&&(h.attrs[".connection"]["stroke-dasharray"]="6,5"),c&&(h.labels=[{position:.5,attrs:{text:{text:c,fill:d,"font-family":"sans-serif"}}}]),new joint.dia.Link(h)}r=new joint.dia.Paper({el:b("#flowchart-container"),width:"100%",height:800,model:o,gridSize:k.gridSize,perpendicularLinks:!0,drawGrid:k.drawGrid}),o.on("batch:start",function(a){"layout"==a.batchName&&c()}),o.on("batch:stop",function(a){"layout"==a.batchName&&d()}),l?(p=gravityflow_flowchart_js_strings.vars.graphScale,e(p,p),o.fromJSON(l),h()):a(),r.on("blank:pointerdown",function(a,b,c){var d=V(r.viewport).scale();dragStartPosition={x:b*d.sx,y:c*d.sy}}),r.on("cell:pointerup blank:pointerup",function(a,b,c){delete dragStartPosition}),b("#flowchart-container").mousedown(function(){b("#flowchart-container svg").css({cursor:"-webkit-grabbing",cursor:"-webkit-grabbing"})}).mouseup(function(){b("#flowchart-container svg").css({cursor:"-webkit-grab",cursor:"-webkit-grab"})}).mousemove(function(a){"undefined"!=typeof dragStartPosition&&r.translate(a.offsetX-dragStartPosition.x,a.offsetY-dragStartPosition.y)})}var i,j=gravityflow_flowchart_js_strings,k=gravityflow_flowchart_js_strings.vars.paper,l=gravityflow_flowchart_js_strings.vars.graphJSON,m=gravityflow_flowchart_js_strings.vars.formId,n=gravityflow_flowchart_js_strings.vars.context,o=new joint.dia.Graph,p=1,q="";"display"==n?(q=ajaxurl+"?action=gravityflowflowchart_print_flowchart",b("#gform-settings").before('<div id="flowchart-icon"><a href="#" title="'+j.flowchart+'"><i class="fa fa-sitemap" aria-hidden="true"></i></a></div><div id="flowchart-toolbar" style="display:none;"><form id="print-flowchart-form" action="'+q+'" method="POST" target="_blank"><i id="flowchart-spinner" class="fa fa-spinner fa-pulse fa-fw"></i><span id="zoom-level">100%</span><a title="'+j.zoomIn+'" id="zoom-in" href="#"><i class="fa fa-search-plus" aria-hidden="true"></i></a><a title="'+j.zoomOut+'" id="zoom-out" href="#"><i class="fa fa-search-minus" aria-hidden="true"></i></a><input id="flowchart-nonce" type="hidden" name="_wpnonce" value="" /><input id="flowchart-json" type="hidden" name="flowchart-json" value="" /><input id="graph-scale" type="hidden" name="graph-scale" value="" /><a title="'+j.print+'" id="print-flowchart" href="#" onclick="GravityFlowFlowchart.print(event);"><i class="fa fa-print" aria-hidden="true" ></i></a><a title="'+j.stepList+'" id="step-list" href="#"><i class="fa fa-list" aria-hidden="true"></i></a></form></div><div><div id="flowchart-container"></div></div>')):h(),b("#flowchart-icon").click(function(a){b("#gform-settings").hide(),b(this).hide(),b("#flowchart-toolbar").show(),c(),b("#flowchart-container").show(),h(),a.preventDefault()});var r;a.print=function(a){a.preventDefault();var c=JSON.stringify(o);b("#flowchart-json").val(c),b("#flowchart-nonce").val(j.vars.nonce),b("#graph-scale").val(p),b("#print-flowchart-form").submit()},b("#zoom-in").click(function(a){g(),a.preventDefault()}),b("#zoom-out").click(function(a){f(),a.preventDefault()}),b("#step-list").click(function(a){b("#flowchart-container").hide(),b("#gform-settings").show(),b("#flowchart-toolbar").hide(),b("#flowchart-icon").show(),a.preventDefault()})})}(window.GravityFlowFlowchart=window.GravityFlowFlowchart||{},jQuery);